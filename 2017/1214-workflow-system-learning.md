# 调度系统简单学习

主要学习来源：内部分享、[浅谈工作流调度系统](http://ju.outofmemory.cn/entry/221885)

### 整个数据平台的架构为：

底层数据：Hbase、Hadoop
再上层是数据处理：Spark、Storm 流程数据处理
然后是数据交换（把数据从一个源转到另一个源）
调度系统（对数据交换任务的调度）
以及数据可视化和数据查询：Hive、Presto
另外还有一套权限系统和元数据系统

### 调度系统

公司数据平台的构架还是很复杂的。。。这次分享主要谈的是任务的调度系统（data streaming solution），这个调度系统的特点是分布式、依赖关系处理与任务定时调度。

#### 调度方式分类：

- 静态执行列表：
  - 根据作业计划，提前生成并持久化任务执行列表
  - 遍历检查列表，满足条件触发执行
  - 代表：Oozie，Azkaban
- 动态执行列表
  - 不提前固化任务执行列表根据触发条件动态生成
  - 通过时间或上游任务触发，根据当前依赖关系生成任务实例
  - 代表 Zeus, chronos

公司的调度系统是动态的。

#### 动态调度

核心问题：

- 时间调度
  - 优先队列：按时间放入任务
  - 轮询检测：检测优先队列的头部，时间到了就执行
- 依赖调度
  - 依赖调度任务树的根必须是时间调度任务，否则无法触发
  - 依赖调度的处理方式：
    - 下游任务可以依赖多个上游任务，这里就是**动态调度的精髓**了，处理方式是：当一个任务完成后，自上而下触发下游的任务，下游任务检查自身的所有依赖任务是否都已经达到符合的状态（可以配置是全完成，或是部分完成等状态），是的话就执行，否则就 pass，等下次触发。
    - 有些任务是依赖调度与定时调度的复合型，这时在被触发并检查依赖任务状态达标后，1：如果已经到了自身定的时间，就可以直接执行；2：如果时间还没到，就把任务置为「已就绪」，然后丢到时间调度的队列里去轮询，「已就绪」状态不再接受上游触发。（其实一般的作法是可以直接丢到队列里，反正很快就能执行）
  - 依赖调度的表示与策略：
    - 一些调度任务是有周期性的，一个任务可能每天跑一次，而实际使用时，下游的任务也并不是简单地就去依赖上游任务，而是会带上一个周期的属性。比如A任务的依赖是：「**当天**-B任务**任意成功**一次」和「**3小时内**-C任务所有调度都**成功执行**」（这里B任务可以是一天执行一次，C任务可以是半小时执行一次」。
    - 上面例子就是依赖调度的两个属性：「依赖期间」「依赖策略」
- 多租户调度
  - 多租户主要是解决资源有限，不同租户（跑任务一方）的优先级不同的问题
  - 租户对调度的要求：
    - 响应时间（触发快慢）：并发度倾斜、限制
    - 周转时间（执行快慢）：资源倾斜、限制
  - 处理方式：模拟并发度、资源的调控，按优先级来
- 多任务类型执行
  - 虽然定位时只是把调度系统简单定位为数据交换任务的上层
  - 然而数据交换平台只是管理和配置各种类型数据源交换的任务，实际运行起来，需要调度系统能把这些N多类型的数据源交换任务运作起来。这时调度系统的执行模块一般会考虑设计成插件、组件化，然后用 pipe 模型统一把一个源转到另一个源

公司的这套系统叫 Jarvis，如果有机会开源了再详细研究一波。

### 其它调度系统

其实 Jarvis 的调度是针对数据任务的，而不是正常的通用脚本、程序任务的，和阿里的 Zeus 系统差不多。
不过调度起其它类型的任务，其实也是差不多的思路。

通用的能调度程序的系统叫工作流调度工系统。

#### 文章

[浅谈工作流调度系统](http://ju.outofmemory.cn/entry/221885)：介绍了几个比较常用的工作流调度系统

[Existing Workflow systems](https://github.com/common-workflow-language/common-workflow-language/wiki/Existing-Workflow-systems)：200 多个开源的工作流调度系统

[awesome-pipeline](https://github.com/pditommaso/awesome-pipeline)：归类总结了 pipeline toolkits，介绍了调度框架、线上的调度平台、工作流 DSL、标准化、开发环境和语言、构建工具（依赖解决并构建）

#### 总结补充

通用工作流可以支持很多类型的任务，unix cmd, shell, python, mapreduce… 等等。

与数据类比起来最大的区别就是执行那部分了，数据类可以抽出通用的框架来实现不同数据源的插件，而通用类就没法这样做了，它往往只是时间到了把命令执行一下，虽然很自由，但没法更加全面的把控执行的情况。

所以通用工作流调度，还需要更关心 monitor 和 metrics（日志、运行时间），以及执行节点的控制。

通用工作流中我比较想看的是 Airbnb 家的 **Airflow**，有机会再好好看看。